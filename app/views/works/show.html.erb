<p id="notice"><%= notice %></p>
<h2>
  <i><%= @work.title %></i>
</h2>

<% if @work.composers[0] %>
  <h5>Composer:</h5>
   <p class="indent">
     <%= link_to @work.composers[0].lastname, @work.composers[0] %>
   </p>
<% end %>

<h5>Author(s):</h5>
<% if @work.authors[0] %>
  <table class="indent">
    <thead>
      <tr>
        <th>Name</th>
        <th>Function</th>
      </tr>
    </thead>
    <tbody>
      <% @work.authors.each do |author| %>
        <tr>
          <td><%= link_to author.lastname, author %></td>
          <td><%= author.writings.find_by(author_id: author.id, work_id: @work.id).function %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p>NA</p>
<% end %>

<h5>Performances</h5>
<table>
  <thead>
    <tr>
      <th colspan="2" style="padding-bottom: 0"></th>
      <th colspan="2" style="padding-bottom: 0" class="right">Receipts</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>DOW</th>
      <th class="right">fl</th>
      <th class="right">kr</th>
      <th>Zinzendorf</th>
    </tr>
  </thead>
  <tbody>
    <% @work.events.each do |event| %>
      <tr>
        <td><%= link_to event.date, event %></td>
        <td><%= event.date.strftime("%a") %></td>
        <td class="right"><%= event.receipts.to_i.divmod(60)[0]%></td>
        <td class="right"><%= event.receipts.to_i.divmod(60)[1]%></td>
        <td class="center"><%= event.zinzendorf %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<p>
  <strong>Genre:</strong>
  <%= @work.genre %>
</p>
<p>
  <% c = @work.events.count %>
  <strong>Total performances:</strong>
  <%= c %>
</p>
<p>
  <% z = @work.events.where(zinzendorf: true).count %>
  <strong>Zinzendorf attendances:</strong>
  <%= z %> (<%= (z.to_f/c.to_f * 100).round(2) %>%)
</p>
<!-- Calculate mean and median receipts -->
  <% r = @work.events.pluck(:receipts)%>
  <% r.map! {|r| r.to_i} %>
<p>
  <strong>Mean receipts:</strong>
    <% sum = 0 %>
    <% r.each do |i| %>
      <% if i == 0 %>
        <% sum = 0 %>
        <% break %>
      <% end %>
      <% sum += i %>
    <% end %>
    <% mean = (sum/@work.events.count).divmod(60) %>
  <% if sum == 0 %>
    <%= "NA" %>
  <% else %>
    <%= mean[0]%> fl <%= mean[1]%> kr
  <% end %>
</p>

<p>
  <strong>Median receipts:</strong>
  <% r = r.sort %>
  <% if r.length.odd? %>
    <% median = r[(r.length - 1)/2] %>  
  <% else %>
    <% median = (r[r.length/2] + r[r.length/2 - 1])/2%>
  <% end %>
  <% if median == 0 %>
    <%= "NA" %>
  <% else %>
    <% median = median.divmod(60) %>
    <%= median[0]%> fl <%= median[1]%> kr
  <% end %>
</p>
<% if @work.notes %>
  <p class="notes">
    <strong>Notes:</strong>
    <% if @work.notes %>
      <%= @work.notes.html_safe %>
    <% end %>
  </p>
<% end %>
<hr class="top">
<p>
  <strong>Created:</strong>
  <%= @work.created_at.to_date.strftime("%a, %-d %b %Y") %>
</p>
<p>
  <strong>Updated:</strong>
  <%= @work.updated_at.strftime("%a, %-d %b %Y, %H:%M %Z") %>
</p>
<% if @work.prev %>
  <%= link_to 'Previous Work', @work.prev %>
  <% if @work.next %>
   |
  <% end %>
<% end %>
<% if @work.next %> 
  <%= link_to 'Next Work', @work.next %>
<% end %>
<hr class="top">
<%= link_to 'Edit', edit_work_path(@work) %> |
<%= link_to 'Back', url_for(:back) %> 
